# Механика бота: путь участника, приглашённого и бота

Упрощённое описание того, как устроена реферальная программа и кто что делает.

---

## Кто есть кто

| Роль | Кто это |
|------|--------|
| **Участник** | Школьник, который уже прошёл очный этап, вступил в канал и зарегистрировался в боте. Он приглашает друзей по своей ссылке. |
| **Приглашённый** | Друг участника. Регистрируется на очный этап по реферальной ссылке. Пока не прошёл очный этап — рефералом не считается. |
| **Бот** | Выдаёт ссылки, считает рефералов, показывает грейды и награды. Связывает участников и приглашённых после импорта из CRM. |

---

## Путь участника (кто приглашает)

1. Заходит в бота по ссылке из закрытого канала (значит, очный этап уже пройден).
2. Указывает **email** и **телефон** — бот выдаёт **личную реферальную ссылку**.
3. Делится ссылкой с друзьями (соцсети, мессенджеры и т.д.).
4. Друзья регистрируются на очный этап по этой ссылке — в CRM сохраняются UTM (email/телефон участника).
5. Админ раз в период выгружает из CRM **CSV** и загружает его в бота.
6. Бот по CSV **связывает** приглашённых с участником: кто прошёл очный этап — тому участнику засчитывается **реферал**.
7. Участник видит в боте:
   - сколько у него **рефералов**;
   - **грейды** (рубежи): например, 10 реф → мерч, 25 реф → встреча;
   - свой **прогресс** до следующего рубежа.
8. Когда участник **переходит рубеж** (например, стало 10 рефералов), бот присылает поздравление и список наград.
9. Админ вручную выдаёт награды и в боте отмечает «Награда выдана».

**Итог для участника:** дал ссылку → друзья прошли очный этап → админ загрузил CSV → начислились рефералы и грейды → получил награды.

---

## Путь приглашённого (кого пригласили)

1. Получает от участника **ссылку** на регистрацию на очный этап (в ссылке зашиты данные участника для CRM).
2. Переходит по ссылке и **регистрируется** на очный этап на сайте.
3. **Проходит очный этап** в реальности.
4. После прохождения получает доступ в **закрытый канал** и может зайти в бота.
5. В боте вводит **email** и **телефон** (те же, что при регистрации на сайте).
6. Админ загружает **CSV из CRM**; в CSV есть email приглашённого и данные того, кто его привёл (реферера).
7. Бот **связывает** запись приглашённого с участником-реферером: приглашённый становится «рефералом» этого участника.
8. Участнику засчитывается +1 реферал; приглашённый дальше может сам стать участником и получать свою ссылку.

**Итог для приглашённого:** зашёл по ссылке друга → зарегистрировался → прошёл очный этап → зашёл в бота → его «привязали» к другу в боте после загрузки CSV.

---

## Путь бота (что делает система)

1. **Регистрация и доступ**
   - Проверяет подписку на закрытый канал (нет подписки — просит подписаться).
   - Принимает email и телефон, выдаёт персональную UTM-ссылку на регистрацию на очный этап.

2. **Хранение данных**
   - Хранит пользователей (telegram_id, email, телефон).
   - Хранит грейды: рубеж (число рефералов) → список наград.
   - Хранит, кому админ отметил «награда выдана» (claims).

3. **Импорт из CRM**
   - Админ загружает CSV: email приглашённого, email/телефон реферера.
   - Бот находит в базе приглашённого по email и реферера по email/телефону.
   - Создаёт связь «реферер — приглашённый» (засчитывает реферала).
   - Если у реферера число рефералов совпало с рубежом грейда — бот отправляет ему поздравление и перечень наград.

4. **Показ участнику**
   - Статистика: сколько рефералов, место в рейтинге.
   - Грейды: таблица «рубеж → награды → статус» (ещё не достиг / достиг / выдано).
   - Прогресс до следующего рубежа.

5. **Админка**
   - Настройка грейдов: добавить/изменить/удалить рубеж и награды.
   - Просмотр «кто достиг» каждый рубеж.
   - Отметка «награда выдана» по каждому участнику и грейду.
   - Рассылка, экспорт в CSV, импорт CSV из CRM.

---

## Упрощённая схема

```
Участник                          Приглашённый                     Бот
   |                                   |                            |
   | получает ссылку                   |                            |
   |<----------------------------------|----------------------------|
   |                                   |                            |
   | даёт ссылку другу --------------->| регистрируется на сайте    |
   |                                   | проходит очный этап        |
   |                                   | вступает в канал, в бота   |
   |                                   | вводит email, телефон      |
   |                                   |---------------------------->| сохраняет
   |                                   |                            |
   | Админ загружает CSV (кто кого привёл)                          |
   |<---------------------------------------------------------------| связывает,
   |                                                                 | +1 реферал,
   |<---------------------------------------------------------------| поздравление
   |                                                                 | при рубеже
   | смотрит грейды, прогресс          |                            |
   |----------------------------------->|<---------------------------| показывает
   |                                   |                            |
   | Админ выдал мерч, отмечает в боте  |                            |
   |<---------------------------------------------------------------| "выдано"
```

---

## Что участнику не нужно делать

- Самому вручную «добавлять» рефералов — это делает только админ через CSV.
- Угадывать, прошёл ли друг очный этап — это видно в CRM и попадает в CSV.
- Спрашивать про награды — бот пишет при достижении рубежа; выдачу организует админ.

Вся механика для участника сводится к: **дать ссылку → дождаться загрузки CSV админом → смотреть рефералов и грейды в боте**.
