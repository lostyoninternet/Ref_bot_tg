# Интеграция с CRM

Как настроить выгрузку из корпоративной CRM для связки рефералов с ботом.

## Что должно быть в CRM

При регистрации школьника на очный этап по реферальной ссылке в CRM должны сохраняться:

1. **Данные регистранта** (школьника): как минимум **email** (и при необходимости телефон).
2. **UTM-параметры** перехода по ссылке:
   - `utm_source` = referal
   - `utm_medium` = ник в Telegram реферера (username без @)
   - `utm_campaign` = email реферера
   - `utm_content` = телефон реферера

По ним потом можно однозначно определить, кто привёл школьника (реферер).

## Формат выгрузки для бота

Бот принимает **CSV-файл** с колонками:

| Назначение | Обязательно | Рекомендуемое имя колонки | Другие поддерживаемые имена |
|------------|-------------|---------------------------|-----------------------------|
| Email того, кого привели (регистранта) | Да | `email` | `e-mail`, `email_registrant`, `mail` |
| Email реферера (из ссылки) | Да | `utm_campaign` | `referrer_email`, `email_referrer` |
| Телефон реферера (из ссылки) | Нет, но желательно | `utm_content` | `referrer_phone`, `phone_referrer` |

Реферер в боте ищется так:

1. По паре **(email + телефон)** реферера — если в выгрузке есть и `utm_campaign`, и `utm_content`.
2. Если не найден: по **одному email** реферера (`utm_campaign`).
3. Для обратной совместимости: если `utm_campaign` — число (telegram_id), реферер ищется по ID.

## Пример выгрузки из CRM

**Минимальный вариант (email регистранта + email реферера):**
```csv
email,utm_campaign
student@mail.ru,referrer@mail.ru
```

**Полный вариант (с телефоном реферера):**
```csv
email,utm_campaign,utm_content
student@mail.ru,referrer@mail.ru,+79001234567
another@mail.ru,other@mail.ru,89001234567
```

Кодировка файла: **UTF-8** (с BOM тоже подойдёт). Разделитель — запятая.

## Как формировать выгрузку в CRM

1. В таблице/отчёте регистраций на очный этап оставьте поля:
   - email (или аналог) регистранта;
   - utm_campaign (или поле, куда пишете email реферера из ссылки);
   - utm_content (или поле с телефоном реферера из ссылки), если оно есть.
2. Экспортируйте в CSV с такими колонками (или с алиасами из таблицы выше).
3. В боте: **Админ-панель** → **Импорт из CRM** → прикрепите CSV.

После импорта бот:

- находит пользователей по **email регистранта** (они должны быть уже в боте и указать тот же email при регистрации в боте);
- находит реферера по **utm_campaign** (+ при наличии по **utm_content**);
- создаёт связку «реферер — реферал» и начисляет билет рефереру;
- отправляет рефереру уведомление о подтверждённом реферале.

## Если CRM отдаёт другие имена колонок

В коде бота заданы алиасы для колонок. Если в выгрузке колонки называются иначе (например, `E-mail`, `Referrer Email`), можно добавить новые алиасы в `bot/handlers/admin.py` в словарь `CRM_COLUMN_ALIASES` и перезапустить бота. Либо переименовать колонки в самом CSV перед загрузкой в бота.

## Webhook (на будущее)

Сейчас связка идёт только через загрузку CSV админом. Если CRM сможет отдавать данные по API (webhook), можно добавить endpoint, который принимает JSON с полями `email` регистранта, `utm_campaign` (и при необходимости `utm_content`) и вызывает ту же логику связки, что и при импорте CSV.
