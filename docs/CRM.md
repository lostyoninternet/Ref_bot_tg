# Интеграция с CRM

Как настроить выгрузку из корпоративной CRM для связки рефералов с ботом.

---

## Пример данных: как должен выглядеть CSV

Ниже — **готовый пример файла**, который можно сохранить как CSV и загрузить в бота (Админ-панель → Импорт из CRM).

**Первая строка — всегда заголовки.** Дальше — по одной строке на каждого школьника, который прошёл очный этап.

```csv
email,utm_campaign,utm_content
maria.ivanova@mail.ru,anna.petrova@gmail.com,+79001234567
dmitry.sidorov@yandex.ru,550585948,
elena.kuznetsova@mail.ru,x7Kp2mNq,v9Lw4nRz
```

**Что здесь в каждой строке:**

| Строка | email | utm_campaign | utm_content | Что сделает бот |
|--------|--------|--------------|------------|------------------|
| 1 | Заголовки | — | — | Не обрабатывается |
| 2 | maria.ivanova@mail.ru | anna.petrova@gmail.com | +79001234567 | Найдёт школьника Марию по email и привяжет её к рефереру Анне (по email + телефон) |
| 3 | dmitry.sidorov@yandex.ru | 550585948 | пусто | Найдёт школьника Дмитрия по email и привяжет к рефереру с Telegram ID 550585948 |
| 4 | elena.kuznetsova@mail.ru | x7Kp2mNq | v9Lw4nRz | Найдёт школьника Елену по email и привяжет к рефереру по токенам (как из Битрикса) |

- **email** — это всегда email **школьника** (того, кого привели и кто прошёл очный этап). Он должен совпадать с тем, что школьник указал в боте.
- **utm_campaign** — это **кто привёл**: либо email реферера, либо его Telegram ID (число), либо токен из ссылки.
- **utm_content** — по желанию: телефон реферера или второй токен. Если нет — можно оставить пустым (как в строке с Дмитрием).

Файл сохраняй в кодировке **UTF-8**, разделитель — **запятая**. Лишние колонки (имя, дата и т.д.) в CSV не мешают — бот использует только эти три (или только email и utm_campaign).

---

## Кратко: какие столбцы должны быть в CSV

В файле **обязательно** должны быть **заголовки** (первая строка) и минимум **две колонки**:

| Что за данные | Имя колонки в CSV (одно из) | Обязательно |
|---------------|-----------------------------|-------------|
| **Email школьника** (кого привели) | `email`, `e-mail`, `email_registrant`, `mail` | ✅ Да |
| **Реферер — идентификатор** (кто привёл) | `utm_campaign`, `referrer_email`, `email_referrer` | ✅ Да |
| **Реферер — телефон** (если есть) | `utm_content`, `referrer_phone`, `phone_referrer` | ❌ Нет, но желательно |

Бот по этим колонкам понимает: **кто** прошёл очный этап (email школьника) и **кто** его привёл (реферер — по utm_campaign и при возможности по utm_content).

---

## Как бот находит реферера (кто привёл)

Реферера можно указать в выгрузке **разными способами**. Бот перебирает их по порядку:

1. **Токены** (из Битрикса по реферальной ссылке с шифрованием):  
   `utm_campaign` и `utm_content` — короткие коды, например `a3Fk9xK2`, `mN7pQ1zR`.

2. **Email + телефон реферера:**  
   `utm_campaign` = email, `utm_content` = телефон, например `referrer@mail.ru`, `+79001234567`.

3. **Telegram ID реферера:**  
   если в `utm_campaign` записано **число** (например `550585948`) — бот ищет реферера по этому Telegram ID. Столбец `utm_content` в этом случае не обязателен.

4. **Только email реферера:**  
   `utm_campaign` = email (например `referrer@mail.ru`), без телефона.

Итого: в выгрузке можно указывать реферера через **токены**, **email и телефон**, **Telegram ID** (число) или **только email**.

---

## Примеры CSV для импорта

**Вариант 1 — минимальный (только email школьника и реферера):**
```csv
email,utm_campaign
student@mail.ru,referrer@mail.ru
ivanov@mail.ru,petrova@gmail.com
```

**Вариант 2 — с телефоном реферера (надёжнее):**
```csv
email,utm_campaign,utm_content
student@mail.ru,referrer@mail.ru,+79001234567
ivanov@mail.ru,petrova@gmail.com,89001234566
```

**Вариант 3 — из Битрикса с токенами в UTM:**
```csv
email,utm_campaign,utm_content
student@mail.ru,a3Fk9xK2,mN7pQ1zR
```

**Вариант 4 — реферер по Telegram ID (число в utm_campaign):**
```csv
email,utm_campaign
student@mail.ru,550585948
```

Дополнительные колонки в файле не мешают — бот смотрит только на нужные имена (или алиасы из таблицы выше).

**Кодировка:** UTF-8 (с BOM подойдёт). **Разделитель:** запятая.

---

## Что должно быть в CRM при регистрации

При регистрации школьника на очный этап по реферальной ссылке в CRM должны сохраняться:

1. **Данные регистранта** (школьника): как минимум **email** (и при необходимости телефон).
2. **UTM-параметры** перехода по ссылке:
   - `utm_source` = referal
   - `utm_medium` = ник в Telegram реферера (username без @)
   - `utm_campaign` = токен или email реферера
   - `utm_content` = токен или телефон реферера

По ним потом формируется выгрузка для бота (колонки как в разделах выше).

---

## Порядок поиска реферера в боте

1. По паре **utm_campaign + utm_content** как по **токенам** (короткие коды из ссылки).
2. По паре **utm_campaign + utm_content** как по **email + телефон** реферера.
3. Если **utm_campaign** — **число** (Telegram ID), реферер ищется по этому ID.
4. По одному **utm_campaign** как по **email** реферера.

## Как формировать выгрузку в CRM

1. В таблице/отчёте регистраций на очный этап оставьте поля:
   - email (или аналог) регистранта;
   - utm_campaign (или поле, куда пишете email реферера из ссылки);
   - utm_content (или поле с телефоном реферера из ссылки), если оно есть.
2. Экспортируйте в CSV с такими колонками (или с алиасами из таблицы выше).
3. В боте: **Админ-панель** → **Импорт из CRM** → прикрепите CSV.

После импорта бот:

- находит пользователей по **email регистранта** (они должны быть уже в боте и указать тот же email при регистрации в боте);
- находит реферера по **utm_campaign** (+ при наличии по **utm_content**);
- создаёт связку «реферер — реферал» и начисляет билет рефереру;
- отправляет рефереру уведомление о подтверждённом реферале.

## Если CRM отдаёт другие имена колонок

В коде бота заданы алиасы для колонок. Если в выгрузке колонки называются иначе (например, `E-mail`, `Referrer Email`), можно добавить новые алиасы в `bot/handlers/admin.py` в словарь `CRM_COLUMN_ALIASES` и перезапустить бота. Либо переименовать колонки в самом CSV перед загрузкой в бота.

## Webhook (на будущее)

Сейчас связка идёт только через загрузку CSV админом. Если CRM сможет отдавать данные по API (webhook), можно добавить endpoint, который принимает JSON с полями `email` регистранта, `utm_campaign` (и при необходимости `utm_content`) и вызывает ту же логику связки, что и при импорте CSV.
