# Шифрование данных и UTM-токены

В боте **email, телефон и ник Telegram** пользователей хранятся в БД **только в зашифрованном виде**. В реферальных ссылках в UTM передаются **короткие токены** (в том числе для ника в `utm_medium`), а не открытые данные.

## Настройка

В `.env` задай ключ шифрования (обязательно для работы токенов и шифрования):

```env
# 64 hex-символа (32 байта) — сгенерировать: python -c "import secrets; print(secrets.token_hex(32))"
ENCRYPTION_KEY=твой_64_символьный_hex_ключ
```

Или строка не короче 32 символов (будет приведена к 32 байтам).

- Если **ENCRYPTION_KEY не задан** — шифрование отключено: в БД и в ссылках остаются открытые email/телефон (как раньше).
- Если **ключ задан** — новые и изменённые email/телелефоны сохраняются зашифрованно, в UTM подставляются короткие токены (например `a3Fk9xK2`, `mN7pQ1zR`).

## Как это работает

1. **Реферальная ссылка**  
   В UTM попадают короткие токены: `utm_medium=<токен_ника>`, `utm_campaign=<токен_почты>`, `utm_content=<токен_номера>`. Один и тот же ник/email/номер всегда даёт один и тот же токен.

2. **Импорт из CRM/Битрикса**  
   В CSV из Битрикса в колонках `utm_campaign` и `utm_content` приходят эти же токены. Бот по ним находит реферера. Поддерживается и старый формат: открытые email и номер в этих колонках.

3. **Экспорт из бота**  
   - **users_export_*.csv** — обычная выгрузка пользователей; **username, email и телефон** в файле **расшифрованы** (только для админа).
   - **utm_key_*.csv** — ключ для подстановки в выгрузку Битрикса: колонки `token`, `type`, `decrypted_value` (типы: `username`, `email`, `phone`). В Excel можно сделать VLOOKUP по токену и подставить реальный ник/email/номер вместо токена.

## Использование ключа в Excel (Битрикс)

1. Скачай из бота оба файла: выгрузку пользователей и `utm_key_*.csv`.
2. В выгрузке из Битрикса в колонках будут токены (utm_campaign, utm_content).
3. Открой `utm_key_*.csv`: там строки вида `a3Fk9xK2,email,user@mail.ru` и `mN7pQ1zR,phone,+79001234567`.
4. В своей таблице сделай VLOOKUP (или СМЕЩ/ИНДЕКС/ПОИСКПОЗ) по токену из колонки «ключ» и подставь `decrypted_value` в нужную колонку — получишь нормальные email и телефоны.

## База данных

- В таблице `users` в полях `username`, `email` и `phone` хранятся только зашифрованные строки (при включённом ключе).
- Таблица `utm_tokens` связывает короткий токен с зашифрованным значением (`username`, `email` или `phone`), чтобы одно значение всегда кодировалось одним токеном.

При первом запуске с новым кодом таблица `utm_tokens` создаётся автоматически. Старые записи в `users` с открытыми email/телефоном продолжают работать (при отображении и при импорте по открытым данным); при следующем изменении контакта пользователем значение будет сохранено уже зашифрованным.
