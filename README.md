# Referral Telegram Bot — Политех

Telegram-бот для реферальной системы привлечения абитуриентов на очный этап поступления в Политех.

## Воронка продаж

1. Участник получает **UTM-ссылку** на сайт регистрации (в ссылке: ник, email и телефон участника).
2. Школьник регистрируется по ссылке — UTM сохраняется в CRM.
3. Школьник проходит очный этап.
4. После прохождения попадает в закрытый ТГ-канал.
5. В канале ссылка на бота → школьник регистрируется в боте (вводит email и номер, делится контактом).
6. Админ загружает **CSV из CRM** (email регистранта + email/телефон реферера).
7. Бот связывает пользователей → рефереру засчитывается реферал.
8. **Грейды** — за рубежи по количеству рефералов пользователь получает награды (мерч, тд и т.д.). Админ настраивает рубежи и отмечает выдачу.

## UTM-параметры реферальной ссылки

Ссылка генерируется так (без пробелов в параметрах):

| Параметр      | Значение        | Описание                    |
|---------------|-----------------|-----------------------------|
| `utm_source`  | `referal`       | Источник — реферальная программа |
| `utm_medium`  | ник в Telegram  | Username участника (без @)  |
| `utm_campaign`| email участника | Для идентификации в CRM     |
| `utm_content` | телефон участника | Номер телефона            |

Пример:  
`https://polytech.alabuga.ru/?utm_source=referal&utm_medium=username&utm_campaign=user%40mail.ru&utm_content=%2B79001234567`

Реферальная ссылка доступна только после указания **email** и **номера телефона** (при регистрации можно «Поделиться контактом»).

## Возможности

- **UTM-ссылки** — уникальная ссылка на сайт с ником, email и телефоном участника.
- **Проверка подписки** — доступ к боту только у подписчиков закрытого канала (middleware включён).
- **Регистрация** — email + номер (кнопка «Поделиться контактом» или ввод вручную).
- **Изменить контакты** — в личном кабинете (✏️ Изменить контакты) можно поменять email и телефон.
- **Импорт из CRM** — гибкий CSV: поддерживаются разные названия колонок (см. ниже).
- **Рассылка** — текст и/или картинка всем участникам.
- **Грейды** — рубежи по количеству рефералов с наградами. Админ задаёт рубежи (например, 10 реф → мерч, тд), пользователь видит прогресс и достигнутые грейды. Админ может отметить «награда выдана».

## Установка

1. Клонируйте репозиторий и перейдите в каталог:
```bash
git clone <repository-url>
cd Ref_bor_tg
```

2. Виртуальное окружение и зависимости:
```bash
python -m venv venv
venv\Scripts\activate   # Windows
pip install -r requirements.txt
```

3. Создайте `.env` из `.env.example` и заполните:
   - `BOT_TOKEN` — токен от @BotFather
   - `ADMIN_IDS` — ваш Telegram ID (через @userinfobot), через запятую при нескольких
   - `CHANNEL_ID` — ID закрытого канала удержания (например -100…)
   - `BOT_USERNAME` — username бота без @
   - `REGISTRATION_URL` — URL страницы регистрации на очный этап

## Запуск

```bash
python -m bot.main
```

## Команды бота

### Пользовательские
- `/start` — регистрация, проверка подписки, ввод email и номера
- `/cabinet` — личный кабинет (статистика, ссылка, подсказки, грейды, изменить контакты)
- `/mylink` — моя реферальная ссылка
- `/stats` — статистика рефералов
- `/tips` — подсказки по привлечению
- `/grades` — грейды (рубежи и награды)

### Админские
- `/admin` — админ-панель
- `/broadcast` — рассылка (текст или картинка с подписью)
- **Управление грейдами** — добавить/редактировать/удалить рубежи, просмотр «кто достиг», отметка «награда выдана»
- `/export` — экспорт базы в CSV (в т.ч. email, phone)

## Импорт из CRM (CSV)

В админ-панели: **Импорт из CRM** → загрузить CSV.

**Обязательные данные по строкам:**
- email **школьника** (кто зарегистрировался по ссылке)
- данные **реферера** (кто дал ссылку): email и/или номер

**Поддерживаемые названия колонок (алиасы):**

| Назначение        | Основное имя     | Алиасы (примеры)                    |
|-------------------|------------------|-------------------------------------|
| Email школьника   | `email`          | `e-mail`, `email_registrant`, `mail` |
| Email реферера    | `utm_campaign`   | `referrer_email`, `email_referrer`   |
| Телефон реферера  | `utm_content`    | `referrer_phone`, `phone_referrer`   |

**Пример CSV:**
```csv
email,utm_campaign,utm_content
student@mail.ru,referrer@mail.ru,+79001234567
```

Реферер ищется по паре (email + телефон); если не найден — по одному email или по старому формату (utm_campaign = telegram_id).

Подробнее: [docs/CRM.md](docs/CRM.md).

## Грейды (рубежи и награды)

- Админ в разделе **Управление грейдами** задаёт рубежи: количество рефералов → список наград (например: 10 реф → мерч, тд).
- Пользователь в разделе **Грейды** видит таблицу: рубеж, награды, статус (достигнут / ещё нет / выдано).
- При импорте CSV, когда рефереру засчитывается новый реферал и он пересекает рубеж, бот отправляет ему поздравление с перечнем наград.
- Админ может открыть «Кто достиг» по любому грейду и отметить «Выдано» для выданных наград.

## Middleware подписки

Включён **SubscriptionMiddleware**: команды и кнопки (кроме `/start` и «Проверить подписку») обрабатываются только если пользователь подписан на закрытый канал. Иначе показывается предложение подписаться.

## Структура проекта

```
bot/
├── main.py           # Точка входа
├── config.py         # Конфигурация, генерация UTM-ссылки
├── scheduler.py      # Заглушка (ранее — напоминание о розыгрыше)
├── handlers/         # start, cabinet, tips, referral, admin
├── keyboards/        # inline, reply
├── middlewares/      # SubscriptionMiddleware
├── services/         # subscription, broadcast, grade
└── database/         # models, crud, session (grades, grade_claims)
docs/
└── CRM.md            # Интеграция с CRM
```

## Миграция БД

При первом запуске после обновления с версии с розыгрышами старые таблицы (`raffles`, `raffle_winners`, `raffle_reminder_settings`) удаляются автоматически, создаются таблицы `grades` и `grade_claims`.
